---
output: rmarkdown::github_document
always_allow_html: yes
bibliography: inst/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 300,
  fig.height = 6, 
  fig.width = 6
)
```

# TreeTracer `r emo::ji("tree")` `r emo::ji("pen")`

The beginnings...

TreeTracer is an R package for creating trace plots of trees from random forests fit using the randomForest R package. Trace plots are useful tools for visually comparing trees from a random forest. See @urbanek:2008 for additional information about trace plots. 

Examples:

```{r}
# Load the package
library(TreeTracer)
```

```{r message = FALSE}
# Load other packages
library(dplyr)
library(ggpcp)
library(ggplot2)
```

## Random forest model 

```{r}
# Load the Palmer penguins data
penguins <- na.omit(palmerpenguins::penguins)
```

```{r fig.width = 6, fig.height = 3}
# Create a parallel coordinate plot of features that will be used to fit
# a random forest colored by the variable of interest to predict (species)
penguins %>%
  ggplot(aes(color = species)) +
  geom_pcp(aes(
    vars = vars(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g)
  ), alpha = 0.5) + 
  scale_color_brewer(palette = "Paired")
```

```{r}
# Fit a random forest
set.seed(71)
penguin.rf <-
  randomForest::randomForest(
    species ~ bill_length_mm + bill_depth_mm + flipper_length_mm + body_mass_g,
    data = penguins, 
    ntree = 50
  )
```

## Trace plots of trees

```{r}
# Generate a trace plot of the first 10 trees in the forest
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = 1:10
)
```

```{r}
# Plot all trees in the forest and adjust alpha
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = 1:penguin.rf$ntree,
  alpha = 0.4
)
```

## Comparison of trees: fit metric from @chipman:1998

Fit metric compares the predictions of the individual trees:

```{r}
# Compute fit metrics between all trees
fit_metrics = compute_fit_metric(penguin.rf, penguins)
head(fit_metrics)

# Get the distance matrix
dist_matrix_fit <- get_dist_matrix(fit_metrics)
```

Hierarchical clustering: 

```{r fig.width = 16, fig.height = 4}
stree <- hclust(dist_matrix_fit, method = "single")
ctree <- hclust(dist_matrix_fit, method = "complete")
atree <- hclust(dist_matrix_fit, method = "average")

par(mfcol=c(1,3))
plot(stree, ylab = "Distance", main = "Single linkage")
plot(ctree, ylab = "Distance", main = "Complete linkage")
plot(atree, ylab = "Distance", main = "Average linkage")
```

Classic MDS: 

```{r}
mds_res <-
  cmdscale(dist_matrix_fit) %>% 
  data.frame() %>%
  rename("Coordinate 1" = "X1", "Coordinate 2" = "X2") %>%
  tibble::rownames_to_column("Tree")

ggplot(mds_res, aes(x = `Coordinate 1`, y = `Coordinate 2`)) + 
  geom_text(aes(label = Tree))
```

```{r}
# Plot tree 8 versus some others to see if any noticeable differences
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = c(12, 27, 3, 10), 
  color_by_id = TRUE,
  alpha = 1
) + 
  scale_color_manual(values = c(rep("grey60", 2), "blue", "grey60"))
```

```{r}
# Plot tree 8 versus some others to see if any noticeable differences
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = c(27, 3, 10), 
  alpha = 1,
  rep_tree = get_tree_data(penguin.rf, 12) %>% mutate(tree = "rep"),
  rep_tree_size = 1.5,
  rep_tree_alpha = 0.57
)
```

```{r}
# Plot tree 8 versus some others to see if any noticeable differences
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = 1:penguin.rf$ntree,
  color_by_id = TRUE,
  alpha = 0.25
) +
  scale_color_manual(values = c(
    rep("black", 11),
    "blue",
    rep("black", 19),
    "blue",
    rep("black", 18)
  )) +
  theme(legend.position = "none")
```

```{r}
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = 1:penguin.rf$ntree, 
  rep_tree = get_tree_data(penguin.rf, 12) %>% mutate(tree = "rep"), 
  rep_tree_size = 1.5
)
```

## Comparison of trees: covariate metric from @banerjee:2012

Covariate metric compares similarities between covariates used

```{r}
# Compute fit metrics between all trees
cov_metrics = compute_covariate_metric(penguin.rf)
head(cov_metrics)

# Get the distance matrix
dist_matrix_cov <- get_dist_matrix(cov_metrics)
```

Hierarchical clustering: 

```{r fig.width = 16, fig.height = 4}
stree <- hclust(dist_matrix_cov, method = "single")
ctree <- hclust(dist_matrix_cov, method = "complete")
atree <- hclust(dist_matrix_cov, method = "average")

par(mfcol=c(1,3))
plot(stree, ylab = "Distance", main = "Single linkage")
plot(ctree, ylab = "Distance", main = "Complete linkage")
plot(atree, ylab = "Distance", main = "Average linkage")
```

Classic MDS: 

```{r}
mds_res <-
  cmdscale(dist_matrix_cov) %>% 
  data.frame() %>%
  rename("Coordinate 1" = "X1", "Coordinate 2" = "X2") %>%
  tibble::rownames_to_column("Tree")

ggplot(mds_res, aes(x = `Coordinate 1`, y = `Coordinate 2`)) + 
  geom_text(aes(label = Tree))
```

```{r}
# Plot tree 8 versus some others to see if any noticeable differences
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = c(11, 22, 42, 26, 33), 
  color_by_id = TRUE, 
  alpha = 0.9
) + 
  scale_color_manual(values = c(rep("green", 2), rep("blue", 3))) 
```

```{r}
# Plot tree 8 versus some others to see if any noticeable differences
trace_plot(
  rf = penguin.rf,
  train = penguins %>% select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),
  tree_ids = 1:penguin.rf$ntree,
  rep_tree = get_tree_data(penguin.rf, 2) %>% mutate(tree = "rep"),
  rep_tree_color = "cyan4",
  rep_tree_size = 2
) + theme_bw()
```

## References

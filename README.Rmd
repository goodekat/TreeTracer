---
output: rmarkdown::github_document
always_allow_html: yes
bibliography: inst/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 300
)
```

# TreeTracer `r emo::ji("tree")` `r emo::ji("pen")`

The beginnings...

TreeTracer is an R package for creating trace plots of trees from random forests fit using the randomForest R package. Trace plots are useful tools for visually comparing trees from a random forest. See @urbanek:2008 for additional information about trace plots. 

```{r message = FALSE}
# Load packages
library(dplyr)
library(ggpcp)
library(ggplot2)
library(TreeTracer)
```

## Penguin data

```{r}
# Load the Palmer penguins data
penguins <- na.omit(palmerpenguins::penguins)
```

```{r}
# Select the features for training the model
penguin_features <- 
  penguins %>% 
  select(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g)
```

```{r fig.width = 6, fig.height = 3}
# Create a parallel coordinate plot of features that will
# be used to fit a random forest colored by the variable 
# of interest to predict (species)
penguins %>%
  ggplot(aes(color = species)) +
  geom_pcp(aes(
    vars = vars(
      bill_length_mm, 
      bill_depth_mm, 
      flipper_length_mm, 
      body_mass_g
    )
  ), alpha = 0.5) + 
  scale_color_brewer(palette = "Paired")
```

## Random forest model 

```{r}
# Fit a random forest
set.seed(71)
penguin_rf <-
  randomForest::randomForest(
    species ~ bill_length_mm + bill_depth_mm + flipper_length_mm + body_mass_g,
    data = penguins, 
    ntree = 50
  )
```

```{r}
# Print feature importance
penguin_rf$importance %>% 
  data.frame() %>% 
  arrange(desc(MeanDecreaseGini))
```

```{r fig.width = 6}
# Trace plots of trees in the forest
trace_plot(
  rf = penguin_rf,
  train = penguin_features,
  tree_ids = 1:penguin_rf$ntree,
  alpha = 0.4
) + 
  theme(aspect.ratio = 1)
```

## Individual Tree Predictions

```{r}
# Predictions for one observation from one tree
get_tree_pred(obs = penguins[1,], rf = penguin_rf, k = 1)
```

```{r}
# Predictions from all trees for five observations
tree_preds <- get_all_tree_preds(data = penguins[1:5,], rf = penguin_rf)
head(tree_preds)
```

```{r eval = FALSE, include = FALSE}
data = penguins[1:10,]
rf = penguin_rf

compute_partition_metric <- function(rf, data) {
  
  # Compute predictions for each tree in the random forest 
  # for each of the specified observations
  tree_preds = get_all_tree_preds(data = data, rf = rf)
 
  # Compute leaf agreement with each tree
  # XXX Need to figure out a smarter way to do this that won't use so
  # much memory
  leaf_agreement <-
    purrr::map(
      .x = 1,
      .f = determine_leaf_agreement,
      tree_preds = tree_preds
    ) 

}

determine_leaf_agreement <- function(tree_id, tree_preds) {
  
  # Get prediction for one tree
  tree_preds_filtered <- tree_preds %>% filter(tree_id == tree_id)
  
  # Extract the observation id and leaf number
  id_and_leaf = tree_preds %>% select(obs_id, leaf_number)
  
  # Determine leaf agreement between all combinations of observations
  data.frame(t(combn(tree_preds_filtered$obs_id, 2))) %>%
    rename("obs_id1" = "X1", "obs_id2" = "X2") %>%
    left_join(id_and_leaf, by = c("obs_id1" = "obs_id")) %>%
    rename("leaf_number1" = "leaf_number") %>%
    left_join(id_and_leaf, by = c("obs_id2" = "obs_id")) %>%
    rename("leaf_number2" = "leaf_number") %>%
    mutate(agree = as.numeric(leaf_number1 == leaf_number2)) %>%
    mutate(tree_id = tree_id) %>%
    select(tree_id, everything())

}


# tree2_agreement <- 
#   data.frame(t(combn(preds_tree2_sub$id, 2))) %>%
#   rename("id1" = "X1", "id2" = "X2") %>%
#   left_join(id_and_leaf2, by = c("id1" = "id")) %>%
#   rename("leaf_number1" = "leaf_number") %>%
#   left_join(id_and_leaf2, by = c("id2" = "id")) %>%
#   rename("leaf_number2" = "leaf_number") %>%
#   mutate(agree = as.numeric(leaf_number1 == leaf_number2))
# 
# sum(abs(tree1_agreement$agree - tree2_agreement$agree)) / choose(dim(preds_tree1_sub)[1], 2)
```

## References
